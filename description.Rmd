---
title: "Overview of Our Project and Some Exploratory Analysis"
author: "By Allison Newman, Elea Bach, Valentina Carducci, Natalie Gomas, and Natali Soraja"
date: "12/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Overview and Motivation

As students, we all have commuted throughout Boston and Cambridge, via Uber/Lyft -- specifically Uber X and the non-luxury Lyft rides, which are the cheapest alternatives present on the apps. However, every time we open the app it feels like a guessing game: what will the wait time be? The cost of the ride? Are the prices of Uber going to be vastly different from Lyft? Should we take the T if it is running? How long should I wait to get a better price? These are only a few of the questions that a consistent user’s experience of ridesharing apps likely elicited. While each different scenario would require a specific cost-benefit analysis (how much money are you willing to spend, how much time do you have available, etc.), we believe it would be interesting to examine which aspects are involved with deciding whether to call an Uber/Lyft and how if there are any general trends in wait times and price for each app. In fact, we would like to understand the algorithms that these rideshare companies are using to set their prices and the distribution of Ubers/Lyft throughout the city at various times during the day.  

We believe that our results could be used by many users to minimize the frustration of the time one tries to wait in the hope of a decrease in prices. We would also like to understand if it is always more convenient to use one of the apps rather than the other choices to improve a user’s experience. 

## Related Work

The COVID-19 pandemic has influenced almost every aspect of our lives. Most of us were quarantined at some point and businesses were closed, leaving us very limited options for places to go. For the rideshare app drivers, the pandemic didn't allow for a safe environment to chauffer passengers. Consumers of ride share apps might notice changes in price patterns and availability since the pandemic. According to Boston Magazine at https://www.bostonmagazine.com/news/2021/07/01/uber-lyft-shortage-boston-passed/, one consumer remarks how  "a Lyft ride from the airport that once cost $23 was now going for more than $100". 
Taking inspiration from a previous BST260 final project by Lauren, Grabriel, and Joshua on predicting hubway station status, we were compelled to explore another alternative to taking the T. 

## Initial Questions

As a starting point, we considered the following scientific and inferential goals: <br> 

 - Predict price for Uber and Lyft rides based on time, day, weather, departure and destination area, and duration
 - Analyze which factors are the most influential to predict price <br> 
 - Compare different types of Ubers and Lyfts within their own company (i.e., prices of luxury cars compared to standard) <br> 
 - Understand the general geographical and monetary trends across the apps <br> 
 - Devise a user-friendly yet accurate predictive model for the price of Uber X and Lyft rides around Boston <br> 

As we were working on the analysis, we were able to answer all of our preliminary questions about the data and achieve our initial goals through the different kind of analyses that we conducted. 

On top of these questions,  we also realized that it would have been particularly interesting in this context to better understand how the surge multiplier that these app use is calculated -- since from our exploratory analysis and first models we saw that it was a very important variable to predict price.

## Data

This dataset is available to anyone from Kaggle's website at https://www.kaggle.com/brllrb/uber-and-lyft-dataset-boston-ma. The data covers rides completed by Uber and Lyft from November 26, 2018 to December 18, 2018. The author fails to mention that data's source, so we cannot verify investigate the validity of the data source and the data collection methods. However, as of December 8, 2021, the Kaggle page was viewed 22,200 times and the csv file was downloaded 3,070 times. The dataset is composed of 693,071 observations and 57 variables - these variables mainly include information on time, location, price, car type, and weather. 


## Exploratory Analysis

```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(tidyverse)
library(lubridate)
library(grid)
require(gridExtra)
```

```{r}
#read the data and store it into a data frame
data = read.csv(unz("rideshare_kaggle.csv.zip", "rideshare_kaggle.csv"))
```


```{r}
dim(data)
```

#### All available columns : 
```{r}
colnames(data)
```


Conversion of datetime and creation of two new variables : 

* time : with date and time
* date : with only date

```{r}
data$time = as.POSIXct(data$datetime, format="%Y-%m-%d %H:%M:%S")
```

```{r}
data$date = as.POSIXct(data$datetime, format="%Y-%m-%d")
```

#### Exploration of types of rides 

```{r}
table(data$cab_type)
```

```{r}
table(data$name)
```

-> The names are not very clear, which ones belong to Lyft? Uber? What's "Taxi"? 

#### Exploration of the "price" variable : 


```{r}
mean(data$price, na.rm = TRUE)
```


```{r}
mean_day_data <- data %>% group_by(date) %>% summarise(price = mean(price,na.rm=TRUE),.groups = "drop") %>% ungroup()
mean_day_data
```
```{r}
mean_hour_data <- data %>% group_by(hour) %>% summarise(price = mean(price,na.rm=TRUE),.groups = "drop") %>% ungroup()
mean_hour_data
```
Surprisingly, the mean price does not vary a lot depending on the hour of the day.

```{r}
plot1 = ggplot(data, aes(x=price)) + geom_histogram(bins=15,color="darkblue", fill="lightblue") + xlab("Price ($)")  + ggtitle ("Distribution of prices, whole dataset") + theme(plot.title = element_text(hjust = 0.5))
plot1
```
```{r}
plot1 = ggplot(filter(data, cab_type == "Uber"), aes(x=price)) + geom_histogram(bins=10,color="darkblue", fill="lightblue") + xlab("Price")  + ggtitle (" Uber") + theme(plot.title = element_text(hjust = 0.5))
plot2 = ggplot(filter(data, cab_type == "Lyft"), aes(x=price)) + geom_histogram(bins=10,color="red", fill="pink") + xlab("Price")  + ggtitle ("Lyft") + theme(plot.title = element_text(hjust = 0.5))


grid.arrange(plot1, plot2, ncol=2, top = textGrob("Distribution of prices for Uber and Lyft",gp=gpar(fontsize=18)))

```

#### Number of rides

```{r}
mean_hour_rides_data <- data %>% group_by(hour) %>% count() %>% ungroup()
mean_hour_rides_data
p <- ggplot(data = mean_hour_rides_data) +
    geom_line(aes(x = hour, y = n),colour = "red") + 
    geom_point(aes(x = hour, y = n),colour = "red") +
    xlab("Hour") +
    ylab(" Number of rides") +
    ggtitle("Number of rides per hour") +
    theme(plot.title = element_text(hjust = 0.5))

p
```


```{r}

data_uber = filter(data, cab_type == "Uber")
data_lyft = filter(data, cab_type == "Lyft")


plot1 = ggplot(data_uber %>% group_by(hour) %>% count() %>% ungroup()) +
    geom_line(aes(x = hour, y = n),colour = "blue") + 
    geom_point(aes(x = hour, y = n),colour = "blue") +
    xlab("Hour") +
    ylab(" Number of rides") + ggtitle (" Uber") + theme(plot.title = element_text(hjust = 0.5)) +
    ylim(c(10000,18000))

plot2 = ggplot(data_lyft %>% group_by(hour) %>% count() %>% ungroup(), aes(x=price)) + geom_line(aes(x = hour, y = n),colour = "pink") + 
    geom_point(aes(x = hour, y = n),colour = "pink") +
    xlab("Hour") +
    ylab(" Number of rides") + ggtitle (" Lyft") + theme(plot.title = element_text(hjust = 0.5)) +
    ylim(c(10000,18000))


grid.arrange(plot1, plot2, ncol=2, top = textGrob("Number of rides per hour",gp=gpar(fontsize=18)))

```



```{r}


data_uber = filter(data, cab_type == "Uber")
data_lyft = filter(data, cab_type == "Lyft")


plot1 = ggplot(data_uber %>% group_by(date) %>% count() %>% ungroup()) +
    geom_line(aes(x = date, y = n),colour = "blue") + 
    geom_point(aes(x = date, y = n),colour = "blue") +
    xlab("Date") +
    ylab(" Number of rides") + ggtitle (" Uber") + theme(plot.title = element_text(hjust = 0.5)) +
    ylim(c(0,45000))

plot2 = ggplot(data_lyft %>% group_by(date) %>% count() %>% ungroup()) + geom_line(aes(x = date, y = n),colour = "pink") + 
    geom_point(aes(x = date, y = n),colour = "pink") +
    xlab("Date") +
    ylab(" Number of rides") + ggtitle (" Lyft") + theme(plot.title = element_text(hjust = 0.5)) +
    ylim(c(0,45000))


grid.arrange(plot1, plot2, ncol=2, top = textGrob("Number of rides per day",gp=gpar(fontsize=18)))

```
--> Similar trends, more rides for Uber than lyft.


#### Destinations and Source 

```{r fig.dim = c(20,20), warnings=FALSE}
ggplot(data = data, aes(x = fct_infreq(destination),fill = cab_type))+ geom_bar(position = "dodge") + coord_flip() +
  xlab("Number of rides") +
  ylab(" Destination") + ggtitle ("Rides destination") + theme(plot.title = element_text(hjust = 0.5)) 
```

```{r fig.dim = c(20,20), warnings=FALSE}
ggplot(data = data, aes(x = fct_infreq(source),fill = cab_type))+ geom_bar(position = "dodge") + coord_flip() +
  xlab("Number of rides") +
  ylab("Source") + ggtitle ("Rides sources") + theme(plot.title = element_text(hjust = 0.5)) 
```



```{r}
ggplot(data = data, aes(x = fct_infreq(short_summary),fill = cab_type))+ geom_bar(position = "dodge") +
  xlab("Short Summary") +
  ylab("Number of rides") + ggtitle ("Number of rides according to Short Summary") + theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.direction = "vertical",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r}
ggplot(data = data, aes(x = fct_infreq(icon),fill = cab_type))+ geom_bar(position = "dodge") +
  xlab("Icon") +
  ylab("Number of rides") + ggtitle ("Number of rides according to Icon") + theme(plot.title = element_text(hjust = 0.5)) + theme(legend.direction = "vertical",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
```{r}
ggplot(data = data, aes(x = fct_infreq(name),fill = cab_type))+ geom_bar(position = "dodge") +
  xlab("Type of ride") +
  ylab("Number of rides") + ggtitle ("Number of rides according to type of ride") + theme(plot.title = element_text(hjust = 0.5)) + theme(legend.direction = "vertical",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


### Correlations between Price and other variables?

#### Surge mulitplier 

```{r}
data_uber = filter(data, cab_type == "Uber")
data_lyft = filter(data, cab_type == "Lyft")


plot1 = ggplot(data_uber) + 
    geom_point(aes(x = surge_multiplier, y = price),colour = "blue") +
    xlab("Surge Multiplier") +
    ylab("Price") + ggtitle (" Uber") + theme(plot.title = element_text(hjust = 0.5)) 

plot2 = ggplot(data_lyft) +
    geom_point(aes(x = surge_multiplier, y = price),colour = "pink") +
    xlab("Surge Multiplier") +
    ylab("Price") + ggtitle (" Lyft") + theme(plot.title = element_text(hjust = 0.5)) 


grid.arrange(plot1, plot2, ncol=2, top = textGrob("Scatter plots of Surge Mutliplier VS Price",gp=gpar(fontsize=18)))

```

Surge multiplier is always 1 for uber. No clear correlation for Lyft? 

```{r}
cor(data_lyft$price, data_lyft$surge_multiplier)
```

#### apparentTemperature
```{r}
data_uber = filter(data, cab_type == "Uber")
data_lyft = filter(data, cab_type == "Lyft")


plot1 = ggplot(data_uber) + 
    geom_point(aes(x = apparentTemperature, y = price),colour = "blue") +
    xlab("Apparent temperature") +
    ylab("Price") + ggtitle (" Uber") + theme(plot.title = element_text(hjust = 0.5)) +
    ylim(c(0,100))

plot2 = ggplot(data_lyft) +
    geom_point(aes(x = apparentTemperature, y = price),colour = "pink") +
    xlab(" Apparent temperature") +
    ylab("Price") + ggtitle ("Lyft") + theme(plot.title = element_text(hjust = 0.5)) +
    ylim(c(0,100))


grid.arrange(plot1, plot2, ncol=2, top = textGrob("Scatter plots of Apparent temperature VS Price",gp=gpar(fontsize=18)))

```

#### Correlation Matrix between all usable variables (Example for Uber)

```{r}
data_uber.numeric <- data_uber[,sapply(data_uber, is.numeric)]
```


```{r}
cormat <- round(cor(data_uber.numeric, use = "complete.obs"),2)
head(cormat)
```


```{r fig.dim = c(22,22)}
library(reshape2)
melted_cormat <- melt(cormat)
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab",
   name="Pearson\nCorrelation") + 
  theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
  axis.ticks = element_blank(),
  legend.direction = "horizontal",
  legend.position="top") +  theme(aspect.ratio=1)
```


### How do numeric variables vary with the hour of the day?


Example for temperature : 

```{r}
mean_hour_data <- data_uber.numeric %>% group_by(hour) %>% summarise(temp = mean(apparentTemperature,na.rm=TRUE),.groups = "drop") %>% ungroup()
p <- ggplot(data = mean_hour_data) +
    geom_line(aes(x = hour, y = temp),colour = "red") + 
    geom_point(aes(x = hour, y = temp),colour = "red") +
    xlab("Hour") +
    ylab("Mean apparent temperature") +
    ggtitle("Mean apparent temperature per hour") +
    theme(plot.title = element_text(hjust = 0.5))

p
```


```{r}
mean_price_data <- data %>% group_by(name) %>% summarise(price = mean(price,na.rm=TRUE),.groups = "drop") %>% ungroup()
ggplot(data = mean_price_data, aes(x = name, y=price)) + geom_bar(stat='identity') +
  xlab("Type of ride") +
  ylab("Mean price") +
  ggtitle ("Mean price of ride according to type of ride") + theme(plot.title = element_text(hjust = 0.5)) + theme(legend.direction = "vertical",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


